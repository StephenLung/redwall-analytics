---
title: Scraping Failed Tabulizer PDFs with AWS Textract - Part 4
author: David Lucey
date: '2020-04-14'
slug: scraping-failed-tabulizer-pdfs-with-aws-textract-part-4
categories: ["R", "Code-Oriented"]
tags: ["pdf", "pdftools", "tabulizer", "textract"]
output:
  html_document:
    code_folding: 'hide'
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<link href="/rmarkdown-libs/jsoneditor/jsoneditor.min.css" rel="stylesheet" />
<script src="/rmarkdown-libs/jsoneditor/jsoneditor.min.js"></script>
<script src="/rmarkdown-libs/jsonedit-binding/jsonedit.js"></script>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>In <a href="https://redwallanalytics.com/2020/04/14/evaluating-mass-muni-cafr-tabulizer-results-part-3/">Evaluating Mass Muni CAFR Tabulizer Results - Part 3</a>, we discovered that we were able to accurately extract ~95% of targeted data using tabulizer, but that might not have been good enough for some applications. In this post, we will show how to subset specific pages of PDFs using <code>pdftools</code> <code>pdf_subset()</code> function, merge those pages with those of other municipalities with tabulizer merge_pdf, and then upload the aggregated document to an AWS S3 bucket with the R paws interface with the AWS SDK. Once in an S3 bucket, we will show how to use paws to call <a href="https://aws.amazon.com/textract/">AWS Textract</a>, which uses OCR and machine learning to try to accurately parse text and tables.</p>
</div>
<div id="aws-textract-using-paws-package" class="section level1">
<h1>AWS Textract Using PAWS Package</h1>
<p>Textract offers a number of <a href="https://aws.amazon.com/blogs/machine-learning/automatically-extract-text-and-structured-data-from-documents-with-amazon-textract/">alternatives</a> for using OCR to extract structured text, forms and tabular data. The API allows to manually upload up to 10 pages and get back a response, and second option of up to 1,000 pages a month for PNG formats for the first three months. This option also doesn’t require upload to an S3 bucket.</p>
<p>Extracting from bulk PDFs, which we used, costs $0.015 per page up to 1 million pages using their asynchronous API on documents which are in an S3 bucket. A logical workflow seemed to be to try tabulizer for free, where possible, and then pay for cases where the document can’t be extracted with tabulizer or the error rate is expected to be high.</p>
<p>In this case, we will show how to subset five tables from <a href="https://www.cityofattleboro.us/ArchiveCenter/ViewFile/Item/223">Attleboro CAFR</a> which failed to scrape three out of five desired fields, and Hudson, MA where the PDF couldn’t be found on the town’s website and is probably an image. In our full project, we aggregated five pages from every CAFR in Massachusetts (30MB file for 700 pages) for a total cost of $11.</p>
<pre class="r"><code># Problem PDFs
path &lt;- &quot;/Users/davidlucey/Desktop/David/Projects/mass_munis/&quot;
bad_cases &lt;- c(&quot;attleboro&quot;, &quot;hudson&quot;)
pdfs &lt;- 
  paste0(path, &quot;data/pdf_cafr/&quot;, bad_cases, &quot;_2018.pdf&quot;)

# Extract 5-pages from Atteboro and Hudson CAFR PDFs with pdftools
pages_attleboro &lt;- 
  as.integer(names(readRDS(paste0(path, &quot;mass.RDS&quot;))[[3]][[&quot;attleboro&quot;]]))
attleboro &lt;-  
  pdf_subset(
    pdfs[1],
    pages = pages_attleboro,
    output = paste0(path, &quot;attleboro.pdf&quot;)
    )

pages_hudson &lt;- 
  as.integer(names(readRDS(paste0(path, &quot;mass.RDS&quot;))[[3]][[&quot;hudson&quot;]]))
hudson &lt;-  
  pdf_subset(
    pdfs[2],
    pages = pages_hudson,
    output = paste0(path, &quot;hudson.pdf&quot;)
    )

# Merge pdfs with tabulizer
  merge_pdfs(
    c(paste0(path, &quot;attleboro.pdf&quot;), 
      paste0(path, &quot;hudson.pdf&quot;)), 
    outfile= &quot;joined.pdf&quot;
    )</code></pre>
<pre><code>[1] &quot;/Users/davidlucey/Desktop/David/Projects/redwall-analytics/content/post/joined.pdf&quot;</code></pre>
</div>
<div id="setting-up-an-s3-bucket-and-uploading-a-pdf" class="section level1">
<h1>Setting up an S3 Bucket and Uploading a PDF</h1>
<p>We then input our AWS credentials and establish an S3 response object (<code>s3</code> below), which we use to instruct AWS to create a S3 bucket, and then upload our subset file of PDFs to S3. When setting the bucket names, it is important not to include punctuation, because these will be rejected. Another mistake we made was uploading the PDF from outside our current working directory, because S3 created the directory structure to match our disc, and Textract seemed to be unable to navigate the file structure to find the document. We showed “munisubset” bucket at the bottom of the code below.</p>
<pre class="r"><code># Save file to S3 Bucket
s3 &lt;- 
  s3( 
    config = list(
      credentials = list(
        creds = list(
          access_key_id = key_get(&quot;AWS_ACCESS_KEY_ID&quot;),
          secret_access_key = key_get(&quot;AWS_SECRET_ACCESS_KEY&quot;)
        )
      ),
      region = &quot;us-east-1&quot;
    )
  )

# Create bucket
bucket_name &lt;- &quot;munisubset&quot;
s3$create_bucket(
  Bucket = bucket_name
)</code></pre>
<pre><code>$Location
[1] &quot;/munisubset&quot;</code></pre>
<pre class="r"><code># Load the file as a raw binary
file_name &lt;- &quot;joined.pdf&quot;
read_file &lt;- file(file_name, &quot;rb&quot;)
s3_object &lt;- 
  readBin(read_file, &quot;raw&quot;, n = file.size(file_name))

# Put object in bucket
s3$put_object(
  Body = s3_object,
  Bucket = bucket_name,
  Key = file_name
)</code></pre>
<pre><code>$Expiration
character(0)

$ETag
[1] &quot;\&quot;9da4dac9b1d6d07b5aac547565f8cca4\&quot;&quot;

$ServerSideEncryption
character(0)

$VersionId
character(0)

$SSECustomerAlgorithm
character(0)

$SSECustomerKeyMD5
character(0)

$SSEKMSKeyId
character(0)

$SSEKMSEncryptionContext
character(0)

$RequestCharged
character(0)</code></pre>
<pre class="r"><code>buckets &lt;- s3$list_buckets()
buckets$Buckets[[1]]</code></pre>
<pre><code>$Name
[1] &quot;munisubset&quot;

$CreationDate
[1] &quot;2020-04-25 13:42:47 GMT&quot;</code></pre>
</div>
<div id="setting-up-textract-object-and-calling-start-document-analysis" class="section level1">
<h1>Setting up Textract Object and Calling Start Document Analysis</h1>
<p>Next, we set up a Textract response object (<code>svc</code> below) and use <code>start_document_analysis()</code> to process the pages in the code below. Note that we select <code>TABLES</code>, but other parameters are <code>FORMS</code> or <code>FORMS | TABLES</code>. It is possible to get help by using ?textract or ?start_document_analysis just like any other function in R. The docs say that <code>start_document_analysis()</code> uses asynchronous analysis to look for relationships between key-value pairs. Running Textract on our 700 pages took more than an hour, so another step would be to figure out how to be notified of the completion with AWS SNS. Once completed, Textract returns the <code>JobID</code> (shown below) which is required to get the analysis in the next step.</p>
<pre class="r"><code># Set up Amazon Textract object
svc &lt;- 
  textract( 
    config = list(
      credentials = list(
        creds = list(
          access_key_id = key_get(&quot;AWS_ACCESS_KEY_ID&quot;),
          secret_access_key = key_get(&quot;AWS_SECRET_ACCESS_KEY&quot;)
        )
      ),
      region = &quot;us-east-1&quot;
    )
  )

# Run Textract on &quot;attleboro&quot; S3 bucket
# Textract function is &quot;start_document_analysis&quot; which asynsychroniously for PDF
# Output is JobID used for &quot;get_document_analysis&quot;
# Feature type is set to &quot;TABLES&quot;
JobId &lt;- 
  svc$start_document_analysis(
    Document = list(
      S3Object = list(
        Bucket = &quot;munisubset&quot;,
        Name = &quot;joined.pdf&quot;
    )
  ),
  FeatureTypes = list(
    &quot;TABLES&quot;
  )
)

# Textract job identifier
JobId</code></pre>
<pre><code>$JobId
[1] &quot;18a5e9270742a15f7abeae3db7ce503c92fa3cd5438a5db579edccf5501f2987&quot;</code></pre>
</div>
<div id="recalling-the-blocks-from-textract" class="section level1">
<h1>Recalling the Blocks from Textract</h1>
<p>Below, we show our call to paws <code>get_document_analysis()</code> using the JobId we received back from Textract above. A few things to mention, Textract stores pages from all of the documents together in “Blocks” when called in bulk from a PDF. We searched around, but it doesn’t seem possible to download the whole job with all of the pages at one time. The only way we could figure out to get the data back into our environment was to while loop over get_document_analysis in the maximum 1,000 increments. This also took time, and our 700 pages of tables came back as over 400,000 blocks commingled together in a json object. To give an idea of the sizes involved, the full aggregated PDF resulted to a 210 MB json, once we had called for all the Blocks.</p>
<p>In the next step, we have our work cut out to extract the key elements from the json. A json is a common object for API calls, but when introduced to a json a few years ago, it seemed to be a hopelessly, impenetrable data structure, and one to be avoided if at all possible. Fortunately, time has moved on, and like many things, it might be possible now. In the next post, we will attempt to reconstitute the Blocks into their original pages, and then parse out the desired elements for comparison. A lot is at stake since we have invested quite a bit of time to get to this point.</p>
<pre class="r"><code># Get 1st list of blocks and &quot;NextToken&quot;
a &lt;- 
  svc$get_document_analysis(JobId= unlist(JobId))

listviewer::jsonedit(
  a[[&quot;Blocks&quot;]][2:10]
)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:768px;" class="jsonedit html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"data":[{"BlockType":"LINE","Confidence":98.4026336669922,"Text":"CITY OF ATTLEBORO, MASSACHUSETTS","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.327934056520462,"Height":0.0120112672448158,"Left":0.347615271806717,"Top":0.0480517074465752},"Polygon":[{"X":0.347615271806717,"Y":0.0480517074465752},{"X":0.675549328327179,"Y":0.0480517074465752},{"X":0.675549328327179,"Y":0.060062974691391},{"X":0.347615271806717,"Y":0.060062974691391}]},"Id":"ff685b13-bbfa-41b0-84c3-c9890c216165","Relationships":[{"Type":"CHILD","Ids":["0816c248-ff44-4105-bf0d-641a1ad9567f","535780fb-a52a-4225-8222-7594b8bec039","359773df-fe37-405f-a274-cddd2084d40a","a1328f0e-119b-4caa-b1aa-c61a9f8c014b"]}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.7185134887695,"Text":"Statement of Net Position","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.168180853128433,"Height":0.0101081877946854,"Left":0.427307635545731,"Top":0.0623589679598808},"Polygon":[{"X":0.427307635545731,"Y":0.0623589679598808},{"X":0.595488488674164,"Y":0.0623589679598808},{"X":0.595488488674164,"Y":0.0724671557545662},{"X":0.427307635545731,"Y":0.0724671557545662}]},"Id":"24406cab-c77b-4691-8b7b-806425a6ed83","Relationships":[{"Type":"CHILD","Ids":["2e67f177-c4a3-4a9d-a8e0-138492d664ee","13f9b087-22b6-46f0-b7ee-bb6557793d33","d39cefcb-d6d6-4a44-a93e-e63c97118f70","f3d1ea40-b831-4cce-b9c3-6bd4d6426bb3"]}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.6482696533203,"Text":"June 30, 2018","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.0910702496767044,"Height":0.0114819929003716,"Left":0.465583741664886,"Top":0.0771534740924835},"Polygon":[{"X":0.465583741664886,"Y":0.0771534740924835},{"X":0.55665397644043,"Y":0.0771534740924835},{"X":0.55665397644043,"Y":0.0886354669928551},{"X":0.465583741664886,"Y":0.0886354669928551}]},"Id":"5c959465-252e-48c6-85e4-8f145c498b0b","Relationships":[{"Type":"CHILD","Ids":["8285e94c-1f94-401b-9b04-e161c5c5cf99","3c786f43-6f61-40d5-b351-cc91e7e95410","a18a27db-a66b-4bc8-b376-a567141b4ebf"]}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.9040069580078,"Text":"Primary Government","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.12462355196476,"Height":0.00960327312350273,"Left":0.534167289733887,"Top":0.154575929045677},"Polygon":[{"X":0.534167289733887,"Y":0.154575929045677},{"X":0.658790826797485,"Y":0.154575929045677},{"X":0.658790826797485,"Y":0.16417920589447},{"X":0.534167289733887,"Y":0.16417920589447}]},"Id":"a95fc135-2d38-47eb-9321-a76a77b76d58","Relationships":[{"Type":"CHILD","Ids":["4493516e-744f-4894-a394-b3b0b4185282","966020c9-8786-483a-85d4-5408383a490e"]}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.7487564086914,"Text":"Component Units","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.101429827511311,"Height":0.0101046785712242,"Left":0.776472806930542,"Top":0.15465897321701},"Polygon":[{"X":0.776472806930542,"Y":0.15465897321701},{"X":0.877902626991272,"Y":0.15465897321701},{"X":0.877902626991272,"Y":0.164763644337654},{"X":0.776472806930542,"Y":0.164763644337654}]},"Id":"23d405e5-99fe-4855-ae8b-21abf2ef0b9d","Relationships":[{"Type":"CHILD","Ids":["ac15bad1-107b-4bf5-a9b2-e1c4530d3991","64b45ed3-f063-4cfe-863b-8497db6f35da"]}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.527946472168,"Text":"Attleboro","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.0568655133247375,"Height":0.0079101175069809,"Left":0.798900783061981,"Top":0.1680678576231},"Polygon":[{"X":0.798900783061981,"Y":0.1680678576231},{"X":0.855766296386719,"Y":0.1680678576231},{"X":0.855766296386719,"Y":0.175977975130081},{"X":0.798900783061981,"Y":0.175977975130081}]},"Id":"92774ae3-cfc5-4796-8f66-48b143825f80","Relationships":[{"Type":"CHILD","Ids":"a52104aa-dd08-4b9b-8c14-aaf1292d1767"}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.8643493652344,"Text":"Governmental","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.0832996964454651,"Height":0.00815461575984955,"Left":0.437423646450043,"Top":0.180639117956161},"Polygon":[{"X":0.437423646450043,"Y":0.180639117956161},{"X":0.520723342895508,"Y":0.180639117956161},{"X":0.520723342895508,"Y":0.188793733716011},{"X":0.437423646450043,"Y":0.188793733716011}]},"Id":"6cf92369-6c75-419b-93e7-3df2e1f78a87","Relationships":[{"Type":"CHILD","Ids":"6e65014c-cf66-4cfe-8eea-7c132ab9f8d7"}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":98.9820556640625,"Text":"Business-Type","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.0816006064414978,"Height":0.0106370896100998,"Left":0.556405425071716,"Top":0.18086265027523},"Polygon":[{"X":0.556405425071716,"Y":0.18086265027523},{"X":0.638006031513214,"Y":0.18086265027523},{"X":0.638006031513214,"Y":0.19149973988533},{"X":0.556405425071716,"Y":0.19149973988533}]},"Id":"9b6c362e-b45c-494b-a998-9a96d4c6899b","Relationships":[{"Type":"CHILD","Ids":"0c21f1df-72f7-449e-8c84-9de8f0e3c159"}],"EntityTypes":[],"SelectionStatus":[],"Page":1},{"BlockType":"LINE","Confidence":99.8070449829102,"Text":"Redevelopment","RowIndex":[],"ColumnIndex":[],"RowSpan":[],"ColumnSpan":[],"Geometry":{"BoundingBox":{"Width":0.0888041853904724,"Height":0.0100483745336533,"Left":0.78336626291275,"Top":0.180877134203911},"Polygon":[{"X":0.78336626291275,"Y":0.180877134203911},{"X":0.872170448303223,"Y":0.180877134203911},{"X":0.872170448303223,"Y":0.190925508737564},{"X":0.78336626291275,"Y":0.190925508737564}]},"Id":"5ce88b78-06a0-4337-84ae-76f345ad62f5","Relationships":[{"Type":"CHILD","Ids":"33d29831-4d5b-4273-b930-12efec804b34"}],"EntityTypes":[],"SelectionStatus":[],"Page":1}],"options":{"mode":"tree","modes":["code","form","text","tree","view"]}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>That concludes this section of setting up S3 and calling Textract which seems like a complete segment. In addition to Textract, the paws link to the AWS SDK opens up so many other options, including the obvious links EC2 and ECS, but also Rekognition for images, Polly for speech to text, Translate for languages and Lambda among others. It seemed like a good place to stop to keep the series in digestible increments. In the next post <a href="https://redwallanalytics.com/2020/04/24/evaluating-mass-muni-cafr-textract-results-part-5/">Evaluating Mass Muni CAFR Textract Results - Part 5</a>, we will show how to parse the complicated json response object back into a table, extract the desired elements for the cases where we failed to match and evaluate how well Textract did on those difficult cases.</p>
</div>
